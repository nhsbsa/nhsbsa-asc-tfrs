{% set sortedLearners = claim.submissions | sortLearnersForTable %}
{% set sortedSubmissions = claim.submissions | sortSubmissionsForTable %}

<div class="govuk-grid-column-full">
    <a href="../view-previous-submissions-handler" class="govuk-back-link govuk-!-margin-bottom-6">Back to previous submissions</a>

    <span class="govuk-caption-l">Claim reference number: {{ claim.claimID }}</span>

    <h2 class="govuk-heading-l" id="training">Learners</h2>
    <p class="govuk-body">This table shows all {% if data.view == "60" %}60 part{% elif data.view == "40" %}40 part{% endif %} submissions with any learner edits <mark class="hods-highlight"><strong>highlighted</strong></mark>.</p>

    <div class="govuk-form-group">
        <label class="govuk-label" for="sort">
            Show
        </label>
        <select class="govuk-select" id="sort" name="sort">
            <option value="changed">Show what's changed</option>
            <option value="everything" selected>Show everything</option>
        </select>
        <button type="submit" class="govuk-button" data-module="govuk-button">
            Apply
        </button>
    </div>
</div>

<div class="govuk-grid-row">
    <div class="govuk-grid-column-one-third">
        <ul class="govuk-list">
            {% for learner in sortedLearners %}
                {% set learnerInfo = learner.learnerID | findLearner(data.learners) %}
                {% if learner.status == "active"%}
                    <li>
                        <a class="govuk-link learner-jump-link" href="#{{learnerInfo.givenName}}" data-tab="{{tabID}}">{{learnerInfo.givenName}} {{learnerInfo.familyName}}</a>
                    </li>
                {% else %}
                <h2 class="govuk-heading-s" style="padding-top: 20px;">Removed</h2>
                    <li>
                        <a class="govuk-link learner-jump-link" href="#{{learnerInfo.givenName}}" data-tab="{{tabID}}">{{learnerInfo.givenName}} {{learnerInfo.familyName}}</a>
                    </li>
                {% endif %}

            {% endfor %}
        </ul>
    </div>

    <div class="govuk-grid-column-two-thirds">
        <div class="moj-scrollable-pane">
            <table class="govuk-table">

                <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
            
                    <th scope="col" class="govuk-table__header" style="min-width: 200px;"><span class="govuk-visually-hidden">Submissions</span></th>
            
                    {% for text in sortedSubmissions | matchSubmissionToText %}
                        <th scope="col" class="govuk-table__header" style="min-width: 200px;">{{text}}</th>
                    {%endfor %}
            
                    </tr>
                </thead>
    <tbody class="govuk-table__body">

        <tr class="govuk-table__row">
            <td class="govuk-table__cell"><strong>Submitted on</strong></td>
            {% for submission in sortedSubmissions %}
                {% if submission.submittedDate %}
                <td class="govuk-table__cell">{{submission.submittedDate | govukDate}}</td>
                {% else %}
                <td class="govuk-table__cell">---</td>
                {% endif %}
            {%endfor %}
        </tr>
                            <tr class="govuk-table__row">
                        <td class="govuk-table__cell"><strong>Processed on</strong></td>
                        {% for submission in sortedSubmissions %}
                            {% if submission.processedDate %}
                            <td class="govuk-table__cell">{{submission.processedDate | govukDate}}</td>
                            {% else %}
                            <td class="govuk-table__cell">---</td>
                            {% endif %}
                        {%endfor %}
                    </tr>

        <tr><td colspan="{{ sortedSubmissions.length + 1 }}" style="height: 60px;"></td></tr>

        {% for learner in sortedLearners %}

            <!-- LEARNER NAME ROW -->
            <tr class="govuk-table__row">
                <td class="govuk-table__cell" id="{{learnerInfo.givenName}}">
                    <strong>Learner {{ loop.index }}</strong>
                </td>

            {% for submission in learner.history %}
                {% set prev = learner.history[loop.index0 + 1] %} {# previous submission (older) #}
                
                {% if submission %}
                    {% set learnerInfo = submission.learnerID | findLearner(data.learners) %}
                    {% set isNew = false %}

                    {# Determine if learner is new: exists now, but not in previous submission, and not the oldest submission #}
                    {% if loop.index0 != (learner.history | length) - 1 and not prev %}
                        {% set isNew = true %}
                    {% endif %}

                    <td class="govuk-table__cell" id="{{learnerInfo.givenName}}">
                        {% if loop.index0 == 0 and learner.status == "removed" %}
                            (Removed)
                        {% elif isNew %}
                            <mark class="hods-highlight"><strong>{{ learnerInfo.givenName }} {{ learnerInfo.familyName }}</strong></mark>
                            <p><strong>(New)</strong></p>
                        {% else %}
                            {% if prev and (learnerInfo.givenName != (prev.learnerID | findLearner(data.learners)).givenName or learnerInfo.familyName != (prev.learnerID | findLearner(data.learners)).familyName) %}
                                <mark class="hods-highlight"><strong>{{ learnerInfo.givenName }} {{ learnerInfo.familyName }}</strong></mark>
                            {% else %}
                                {{ learnerInfo.givenName }} {{ learnerInfo.familyName }}
                            {% endif %}
                        {% endif %}
                    </td>
                    {% elif loop.index != 1 %}
                        <td class="govuk-table__cell" id="{{learnerInfo.givenName}}">---</td>
                    {% else %}
                        <td class="govuk-table__cell" id="{{learnerInfo.givenName}}">(Removed)</td>
                    {% endif %}
            {% endfor %}

            </tr>



            <!-- LEARNER ID ROW -->
            <tr class="govuk-table__row">
                <td class="govuk-table__cell">
                    <strong>NI number</strong>
                </td>

                {% for submission in learner.history %}
                    {% if submission %}
                        <td class="govuk-table__cell">{{submission.learnerID}}</td>
                    {% else %}
                        <td class="govuk-table__cell">---</td>
                    {% endif %}
                {% endfor %}
            </tr>

            
            <!-- COMPLETION DATE ROW -->
            <tr class="govuk-table__row">
                <td class="govuk-table__cell"><strong>Completion date</strong></td>
                {% for submission in learner.history %}
                    {% set prev = learner.history[loop.index0 + 1] %}

                    {% if submission and submission.completionDate %}
                        {% if prev and submission.completionDate != prev.completionDate %}
                            <td class="govuk-table__cell">
                                <mark class="hods-highlight">
                                    <strong>{{ submission.completionDate | govukDate }}</strong>
                                </mark>
                            </td>
                        {% else %}
                            <td class="govuk-table__cell">{{ submission.completionDate | govukDate }}</td>
                        {% endif %}
                    {% else %}
                        <td class="govuk-table__cell">---</td>
                    {% endif %}
                {% endfor %}
            </tr>

            <!-- EVIDENCE OF COMPLETION ROW -->
            <tr class="govuk-table__row">
                <td class="govuk-table__cell"><strong>Evidence of completion</strong></td>

                {% for submission in learner.history %}
                    {% set prev = learner.history[loop.index0 + 1] %}

                    {% if submission and submission.evidenceOfCompletion %}
                        {% if prev and submission.evidenceOfCompletion != prev.evidenceOfCompletion %}
                            <td class="govuk-table__cell">
                                <mark class="hods-highlight"><strong>{{ submission.evidenceOfCompletion }}</strong></mark>
                                (<a class="govuk-link" target="_blank"
                                    href="/public/images/{{ submission.evidenceOfCompletion }}">open</a>)
                            </td>
                        {% else %}
                            <td class="govuk-table__cell">
                                {{ submission.evidenceOfCompletion }}
                                (<a class="govuk-link" target="_blank"
                                    href="/public/images/{{ submission.evidenceOfCompletion }}">open</a>)
                            </td>
                        {% endif %}
                    {% else %}
                        <td class="govuk-table__cell">---</td>
                    {% endif %}
                {% endfor %}

            </tr>

            <!-- REQUESTED EDITS ROW -->
            <tr class="govuk-table__row">
                <td class="govuk-table__cell"><strong>Requested edits</strong></td>

                {% for submission in learner.history %}
                    {% if submission and submission.evidenceOfCompletionReview and submission.evidenceOfCompletionReview.outcome == "queried" %}
                        <td class="govuk-table__cell">
                            {{ submission.evidenceOfCompletionReview.note | trunctateString }}
                            <br>
                            <a class="govuk-link" href="/showLearnerNote?submittedDate={{ submission.completionDate }}">
                                â€¦ see more
                            </a>
                        </td>
                    {% else %}
                        <td class="govuk-table__cell">---</td>
                    {% endif %}
                {% endfor %}
            </tr>

            <!-- spacer between learners -->
            <tr><td colspan="{{ sortedSubmissions.length + 1 }}" style="height: 60px;"></td></tr>

        {% endfor %}
    </tbody>


            </table>
          
        </div>
        </div>
         {% if  claim.claimType =="60" %}
            {% if pairClaim != null %}
            <p class="govuk-body govuk-!-margin-top-4" >View the <a href="./org-view-main?id={{pairClaim.claimID}}&claimScreen=claim" class="govuk-link">40 part of the claim</a>, which covers evidence of {% if claim.isPaymentPlan == true%}both payment and {% endif%} completion.</p>
            {% else %}
            <p class="govuk-body govuk-!-margin-top-4">The 40 part of the claim, which covers evidence of {% if claim.isPaymentPlan == true%}both payment and {% endif%} completion, has not been submitted yet.</p>
            {% endif %}
        {% endif %}

        {% if claim.claimType =="40"%}
        <p class="govuk-body govuk-!-margin-top-4">View the <a href="./org-view-main?id={{pairClaim.claimID}}&claimScreen=claim" class="govuk-link">60 part of the claim</a>, which covers payment evidence.</p>
        {% endif %}
    </div>

    {% if data.showLearnerNote %}
        {% include "../claim-view/view-learner-note.html" %}
    {% endif %}
</div>  