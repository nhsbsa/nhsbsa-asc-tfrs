{% extends "../_layouts/claims-main.html" %}
{% set claim = data.id | findClaim(data.claims, data.org.workplaceID) %}

{% if claim.claimType == "60" %}
  {% set pairClaim = claim.claimID | findPair(data.claims) %}
{% elif claim.claimType == "40" %}
  {% set pairClaim = claim %}
  {% set claim = pairClaim.claimID | findPair(data.claims) %}
{% endif %}

{% if claim.claimType == "60" %}  

  {% if (claim.status == "queried") %}
    {% set submission = claim | getDraftSubmission %}
  {% else %}
    {% set submission = claim | getMostRelevantSubmission %}
  {% endif %}
  {% if (pairClaim and pairClaim.status == "queried") %}
    {% set pairSubmission = pairClaim | getDraftSubmission %}
  {% else %}
    {% set pairSubmission = pairClaim | getMostRelevantSubmission %}
  {% endif %}

{% else %}

  {% if (claim.status == "queried") %}
    {% set submission = claim | getDraftSubmission %}
  {% else %}
    {% set submission = claim | getMostRelevantSubmission %}
  {% endif %}

{% endif %}

{% block pageTitle %}
  {% if (claim.claimType == "100") %}
    {% if data.submitError.claimValid != null and not data.submitError.claimValid %}Error: {% endif %}Claim: {{claim.claimID}} — {{serviceName}} — GOV.UK
  {% else %}
    {% if data.submitError.claimValid != null and not data.submitError.claimValid %}Error: {% endif %}Combined claim: {{claim.claimID | removeClaimSuffix}} — {{serviceName}} — GOV.UK
  {% endif %}
{% endblock %}

{% block beforeContent %}
  {% if (data.fromSearchResults) %}
    <a href="advanced-search" class="govuk-back-link">Back</a>
  {% elif (data.fromSearchId) %}
    <a href="../manage-claims-home?fromSearchId" class="govuk-back-link">Back</a>
  {% elif (claim.status != "not-yet-submitted") and (claim.status != "queried") and (pairClaim.status != "queried") and (pairClaim.status != "not-yet-submitted")%}
    <a href="../manage-claims?statusID={{ data.statusID }}" class="govuk-back-link">Back</a>
  {% endif %} 
{% endblock %}


{% block content %}


<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    {% if data.learnerConfirmation != null %}
      {% set learnerInfo = data.learnerConfirmation.learner | findLearner(data.learners) %}
      <div class="moj-banner moj-banner--success" role="region" aria-label="Success">

        <svg class="moj-banner__icon" fill="currentColor" role="presentation" focusable="false"
          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25" height="25" width="25">
          <path d="M25,6.2L8.7,23.2L0,14.1l4-4.2l4.7,4.9L21,2L25,6.2z" />
        </svg>

        <div class="moj-banner__message">
          {% if data.learnerConfirmation.type == "removal" %}
            {{learnerInfo.givenName}} {{learnerInfo.familyName}} removed from the {% if claim.claimType == "100" or (claim.claimType == "60" and claim.status != "approved") %}claim {% else %}40 part of the claim{% endif %}
          {% endif %}
        </div>

      </div>
    {% endif %}

    {% if data.submitError.claimValid != null and not data.submitError.claimValid %}
      {% include "../_components/claim-sections/errorCatch.html" %}
    {% endif %}
    <h1 class="govuk-heading-xl">
      {% if (claim.claimType == "100") %}
        {{ claim.claimID }}
      {% else %}
        Combined claim: {{ claim.claimID | removeClaimSuffix }}
      {% endif %}
    </h1>

    {% if (claim.claimType == "100") %}

      <p class="govuk-body">This {{ claim.claimType | typeTag }} claim 
        {% if (claim.status == "not-yet-submitted") %}
          is {{ claim.status | statusTag(data.statuses) }}
        {% elif (claim.status == "queried") %}
          {{ claim.status | statusTag(data.statuses) }}
        {% else %}
          was {{ claim.status | statusTag(data.statuses) }} on {{ (claim | statusDate) | govukDate }}.
        {% endif %}</p>

    {% elif (claim.claimType == "60") %}

      <p class="govuk-body">The {{ "60" | typeTag }} part of this claim 
        {% if (claim.status == "not-yet-submitted") %}
          is {{ claim.status | statusTag(data.statuses) }}
        {% elif (claim.status == "queried") %}
          {{ claim.status | statusTag(data.statuses) }}
        {% else %}
          was {{ claim.status | statusTag(data.statuses) }} on {{ (claim | statusDate) | govukDate }}.
        {% endif %}</p>

      <p class="govuk-body">The {{ "40" | typeTag }} part of this claim 
        {% if pairClaim != null %}

          {% if (pairClaim.status == "not-yet-submitted") %}
            is {{ pairClaim.status | statusTag(data.statuses) }}
          {% elif (pairClaim.status == "queried") %}
            {{ pairClaim.status | statusTag(data.statuses) }}
          {% else %}
            was {{ pairClaim.status | statusTag(data.statuses) }} on {{ (pairClaim | statusDate) | govukDate }}.
          {% endif %} 
        
        {% elif claim.status =="rejected" %}cannot therefore be submitted.{% else %}cannot be started until the 60 part is approved.{% endif %}</p>

    {% endif %}

    {% include "../_components/claim-sections/claimAmount.html" %}

    {% if not ((claim.claimType == "100" or claim.claimType == "60") and  claim.status == "not-yet-submitted") %}
      {% include "../_components/claim-sections/alertSection.html" %}
    {% endif %}

  </div>
</div>


<div class="govuk-grid-row" style="margin-top: 20px;">

  <div class="govuk-grid-column-two-thirds">
    <h2 class="govuk-heading-l" id="training">Claim details</h2>
    
     {% if claim.claimType == "100" %}
      {% include "../_components/claim-sections/100-claim.html" %}
     {% else %}
      {% include "../_components/claim-sections/6040-claim.html" %}

     {% endif %}

  </div>

  <div class="govuk-grid-column-one-third">

    <p class="govuk-body"><a class="govuk-link" href="claim-history.html">View timeline</a></p>

    {% if claim.status != "not-yet-submitted" and (claim.submissions | length) > 1 and claim.claimType == "100" %}
      <p class="govuk-body"><a class="govuk-link" href="../claim/previousSubmissionsTable?view=100&filter=everything">View claim history</a></p>
    {% endif %}

    {% if (claim.status != "not-yet-submitted" and pairClaim.status != "queried" and claim.submissions.length > 1 and claim.claimType == "60") %}
      <p class="govuk-body"><a class="govuk-link" href="../claim/previousSubmissionsTable?view=60&filter=everything" >View 60 part history</a></p>
    {% endif %}
    {% if (pairClaim.status != "not-yet-submitted") and (pairClaim.submissions | length) > 1 and pairClaim.claimType == "40"%}
        <p class="govuk-body"><a class="govuk-link" href="../claim/previousSubmissionsTable?view=40&filter=everything">View 40 part history</a></p>
    {% endif %}
  </div>

</div> 

{% endblock %}




















