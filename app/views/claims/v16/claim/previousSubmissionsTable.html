{% extends "../_layouts/claims-main.html" %}
{% set claim = data.id | findClaim(data.claims, data.org.workplaceID) %}
{% set sortedSubmissions = claim.submissions | sortSubmissionsForTable %}

{% block beforeContent %}
<p class="govuk-body"><a href="claim-details" class="govuk-back-link">Back to claim details</a></p>
{% endblock %}

{% block content %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

      <span class="govuk-caption-l">Claim reference number: {{ claim.claimID }}</span>

        <h2 class="govuk-heading-l" id="training">Claim submissions</h2>
        <p class="govuk-body">This table shows your current draft and earlier submissions with any updates you've made <mark class="hods-highlight"><strong>highlighted</strong></mark>.</p>
        
        <div class="moj-scrollable-pane">
            <table class="govuk-table">
          
              <thead class="govuk-table__head">
                <tr class="govuk-table__row">
          
                  <th scope="col" class="govuk-table__header" style="min-width: 200px;"><span class="govuk-visually-hidden">Submissions</span></th>
          
                  {% for text in claim.submissions | matchSubmissionToText %}
                    <th scope="col" class="govuk-table__header" style="min-width: 200px;">{{text}}</th>
                  {%endfor %}
          
                </tr>
              </thead>
          
              <tbody class="govuk-table__body">
          
                <tr class="govuk-table__row">
                <td class="govuk-table__cell"><strong>Submission date</strong></td>
                {% for submission in sortedSubmissions %}
                  {% if submission.submittedDate %}
                  <td class="govuk-table__cell">{{submission.submittedDate | govukDate}}</td>
                  {% else %}
                  <td class="govuk-table__cell">---</td>
                  {% endif %}
                {%endfor %}


                </tr>
          
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Submitted by</strong></td>
                    {% for submission in sortedSubmissions %}
                      {% if submission.submitter %}
                        <td class="govuk-table__cell">{{(submission.submitter | findUser(data.org)).givenName}} {{(submission.submitter | findUser(data.org)).familyName}}</td>
                      {% else %}
                        <td class="govuk-table__cell">---</td>
                      {% endif %}
                    {%endfor %}             
                </tr>

                <tr class="govuk-table__row">
                  <td class="govuk-table__cell"><strong>Processed date</strong></td>

                  {% for submission in sortedSubmissions %}
                    {% if submission.processedDate %}
                      <td class="govuk-table__cell">{{submission.processedDate | govukDate}}</td>
                      {% else %}
                      <td class="govuk-table__cell">---</td>
                    {% endif %}
                  {%endfor %}
                  </tr>
          
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Edits requested</strong></td>
                    {% for submission in sortedSubmissions %}

                      {% if (submission.evidenceOfPaymentReview.outcome == "queried" or submission.evidenceOfCompletionReview.outcome == "queried") %}
                        <td class="govuk-table__cell">
                          {% set text = submission | formatText %}
                            {{text | trunctateString}} </br> <a class="govuk-link" href="/showComparisonNote?noteType=sixtyQuery&submittedDate={{submission.submittedDate}}">...See more</a></br>
                        </td>

                      {% else %}
                        <td class="govuk-table__cell">---</td>
                      {% endif %}
                      
                    {%endfor %}  
                  </tr>

                  <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><span class="govuk-visually-hidden">Empty row</span></td>
                    {% for submission in sortedSubmissions %}

                        <td class="govuk-table__cell">
                          <span class="govuk-visually-hidden">Empty row</span></br>
                          <span class="govuk-visually-hidden">Empty row</span></br>
                          <span class="govuk-visually-hidden">Empty row</span>
                        </td>

                      
                    {%endfor %}  
                  </tr>
                  
          
                  {% if data.view == "100" or data.view == "60"  %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Training</strong></td>
                    {% for submission in sortedSubmissions %}
                      {% set training = submission.trainingCode | findTraining(data.training) %}
                      {% if training %}

                        {% if (training.code !== sortedSubmissions[loop.index0 + 1].trainingCode and (loop.index0 + 1) <= (sortedSubmissions.length - 1)  ) or (training.code !== sortedSubmissions[loop.index0 - 1].trainingCode and (loop.index0 - 1) >= 0) %}
                          <td class="govuk-table__cell"><mark class="hods-highlight"><strong>{{training.code}}</br>{{training.title}}</strong></mark></td>
                        {% else %}
                        <td class="govuk-table__cell">{{training.code}}</br>{{training.title}}</td>
                        {% endif %}

                      {% else %}
                        <td class="govuk-table__cell">---</td>
                      {% endif %}
                    {%endfor %}  
                </tr>
                {% endif %}

                {% if data.view == "100" or data.view == "60"  %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Start date</strong></td>
                    {% for submission in sortedSubmissions %}
                      {% if submission.startDate %}

                      {% if (submission.startDate !== sortedSubmissions[loop.index0 + 1].startDate and (loop.index0 + 1) <= (sortedSubmissions.length - 1)  ) or (submission.startDate !== sortedSubmissions[loop.index0 - 1].startDate and (loop.index0 - 1) >= 0) %}
                        <td class="govuk-table__cell"><mark class="hods-highlight"><strong>{{submission.startDate | govukDate}}</strong></mark></td>
                      {% else %}
                        <td class="govuk-table__cell">{{submission.startDate | govukDate}}</td>
                      {% endif %}

                      {% else %}
                      <td class="govuk-table__cell">---</td>
                      {% endif %}
                    {%endfor %}
                </tr>
                {% endif  %}

                {% if data.view == "100" or data.view == "60"  %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Payment date</strong></td>
                    {% for submission in sortedSubmissions %}
                      {% if submission.costDate %}


                      {% if (submission.costDate !== sortedSubmissions[loop.index0 + 1].costDate and (loop.index0 + 1) <= (sortedSubmissions.length - 1)  ) or (submission.costDate !== sortedSubmissions[loop.index0 - 1].costDate and (loop.index0 - 1) >= 0) %}
                        <td class="govuk-table__cell"><mark class="hods-highlight"><strong>{{submission.costDate | govukDate}}</strong></mark></td>
                      {% else %}
                        <td class="govuk-table__cell">{{submission.costDate | govukDate}}</td>
                      {% endif %}
                      
                      
                      {% else %}
                      <td class="govuk-table__cell">---</td>
                      {% endif %}
                    {%endfor %}
                </tr>
                {% endif %}

                {% if data.view == "100" or data.view == "60"  %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Evidence of payment</strong></td>
                    {% for submission in sortedSubmissions %}
                      {% if submission.evidenceOfPayment %}
                      <td class="govuk-table__cell">
                        {% for evidence in submission.evidenceOfPayment %}
                          <a class="govuk-link" href="#">{{evidence}}</a></br>
                        {% endfor %}
                      </td>
                      {% else %}
                      <td class="govuk-table__cell">---</td>
                      {% endif %}
                    {%endfor %}
                </tr>
                {% endif %}

                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Learner</strong></td>
                    {% for submission in sortedSubmissions %}
                      {% if submission.learnerID %}

                        {% if (submission.learnerID !== sortedSubmissions[loop.index0 + 1].learnerID and (loop.index0 + 1) <= (sortedSubmissions.length - 1)  ) or (submission.learnerID !== sortedSubmissions[loop.index0 - 1].learnerID and (loop.index0 - 1) >= 0) %}
                          <td class="govuk-table__cell"><mark class="hods-highlight"><strong>{{(submission.learnerID | findLearner(data["learners"])).givenName}} {{(submission.learnerID | findLearner(data["learners"])).familyName}}</strong></mark></td>
                        {% else %}
                          <td class="govuk-table__cell">{{(submission.learnerID | findLearner(data["learners"])).givenName}} {{(submission.learnerID | findLearner(data["learners"])).familyName}}</td>
                        {% endif %}


                      {% else %}
                        <td class="govuk-table__cell">---</td>
                      {% endif %}
                    {%endfor %}   
                </tr>

                {% if data.view == "100" or data.view == "40"  %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Completion date</strong></td>
                    {% for submission in sortedSubmissions %}
                      {% if submission.completionDate %}

                      {% if (submission.completionDate !== sortedSubmissions[loop.index0 + 1].completionDate and (loop.index0 + 1) <= (sortedSubmissions.length - 1)  ) or (submission.completionDate !== sortedSubmissions[loop.index0 - 1].completionDate and (loop.index0 - 1) >= 0) %}
                        <td class="govuk-table__cell"><mark class="hods-highlight"><strong>{{submission.completionDate | govukDate}}</strong></mark></td>
                      {% else %}
                        <td class="govuk-table__cell">{{submission.completionDate | govukDate}}</td>
                      {% endif %}


                      {% else %}
                      <td class="govuk-table__cell">---</td>
                      {% endif %}
                    {%endfor %}
                </tr>
                {% endif %}

                {% if data.view == "100" or data.view == "40"  %}
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell"><strong>Evidence of completion</strong></td>
                    {% for submission in sortedSubmissions %}
                      {% if submission.evidenceOfCompletion %}

                      {% if (submission.evidenceOfCompletion !== sortedSubmissions[loop.index0 + 1].evidenceOfCompletion and (loop.index0 + 1) <= (sortedSubmissions.length - 1)  ) or (submission.evidenceOfCompletion !== sortedSubmissions[loop.index0 - 1].evidenceOfCompletion and (loop.index0 - 1) >= 0) %}
                        <td class="govuk-table__cell"><mark class="hods-highlight"><strong><a class="govuk-link" href="#">{{submission.evidenceOfCompletion}}</a></strong></mark></td>
                      {% else %}
                        <td class="govuk-table__cell"><a class="govuk-link" href="#">{{submission.evidenceOfCompletion}}</a></td>
                      {% endif %}
                      
                      
                      {% else %}
                      <td class="govuk-table__cell">---</td>
                      {% endif %}
                  {%endfor %}
                </tr>
                {% endif %}

                <tr class="govuk-table__row">
                  <td class="govuk-table__cell"><strong>Supporting note</strong></td>
                  {% for submission in sortedSubmissions %}
                      {% if submission.supportingNote %}

                      {% if (submission.supportingNote !== sortedSubmissions[loop.index0 + 1].supportingNote and (loop.index0 + 1) <= (sortedSubmissions.length - 1)  ) or (submission.supportingNote !== sortedSubmissions[loop.index0 - 1].supportingNote and (loop.index0 - 1) >= 0) %}
                        <td class="govuk-table__cell"><mark class="hods-highlight"><strong>{{submission.supportingNote}}</strong></mark></td>
                      {% else %}
                        <td class="govuk-table__cell">{{submission.supportingNote}}</td>
                      {% endif %}

                      {% else %}
                      <td class="govuk-table__cell">---</td>
                      {% endif %}
                    {%endfor %}
              </tr>

              </tbody>
            </table>
          
          </div>
    </div>

    {% if data.showNote %}
    {% include "../_components/claim-sections/claim-history/view-note.html" %}
  {% endif %}
</div>

{% endblock %}